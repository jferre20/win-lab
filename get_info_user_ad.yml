---
- name: Playbook de teste para o pessoal
  gather_facts: false
  hosts: ad01.jferre.local
  
  vars:
    attributes:    
      terceiro:    
        Description: "{{ description_info }}"
      interno:
        Title: "{{ title_info }}"

    ansible_connection: winrm
    ansible_user: administrator 
    ansible_password: redhat@123
    ansible_port: 5985
    ansible_winrm_transport: ntlm
    usuario_espelho: Joao Ferreira
  tasks:
    - name: Consulta usuario espelho no AD
      microsoft.ad.object_info:
        ldap_filter: (&(Name={{ usuario_espelho }}))
        properties:
          - DistinguishedName
          - MemberOf
          - Title
          - Department
          - Description
        search_base: DC=jferre,DC=local
      register: baseuser_info
          
    - name: Obter OU e grupos do usu√°rio
      set_fact:
        ou_info: "{{ ((baseuser_info.objects | map(attribute='DistinguishedName'))[0] | split(','))[1:] | join(',') }}"
        groups_info: "{{ baseuser_info.objects | map(attribute='MemberOf') }}"
        title_info: "{{ (baseuser_info.objects | map(attribute='Title'))[0] }}"
        department_info: "{{ (baseuser_info.objects | map(attribute='Department'))[0] }}"
        description_info: "{{ (baseuser_info.objects | map(attribute='Description'))[0] }}"
          
    - debug:
        msg: "{{ item }}"
      with_items:
        - "{{ ou_info }}"
        - "{{ groups_info }}"
        - "{{ title_info }}"
        - "{{ department_info }}"
        - "{{ description_info }}"

    - debug:
        msg: "{{ attributes[profile] }}"

    - name: Lock account when description is filled
      microsoft.ad.user:
        identity: "CN={{ usuario_espelho }},CN=Users,DC=jferre,DC=local"
        enabled: false
      when: description_info | regex_search('Using')
